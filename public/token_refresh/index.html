<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>トークン管理</title>
    <link rel="icon" href="data:," />

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- jsbn -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbn/1.1.0/jsbn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbn/1.1.0/jsbn2.min.js"></script>

    <!-- SJCL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.8/sjcl.min.js"></script>

    <!-- CryptoJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <!-- moment -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>

    <!-- AWS SDK v2 -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1692.0.min.js"></script>

    <!-- Amazon Cognito  SDK -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1692.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@latest/dist/amazon-cognito-identity.min.js"></script>

    <!-- 共通スタイル -->
    <link rel="stylesheet" href="../common/style.css" />
    
    <!-- 共通スクリプト -->
    <script src="/common/scripts.js"></script>
    <script src="/common/navi/navigation.js"></script>
    
    <!-- 自作 -->
    <script src="./script.js"></script>

  </head>
  <body>
    <!-- トークン管理コンテンツ -->
    <div>
      <h1 class="page-title">トークン管理</h1>

      <!-- Refresh Tokenの説明 -->
      <div class="token-explanation">
        <h3>Refresh Tokenについて</h3>
        <p>Refresh Tokenは、Access Tokenを更新するために使用される長期間有効なトークンです。</p>
        <ul>
          <li><strong>Access Token</strong>: APIアクセスに使用される短期間有効なトークン（通常1時間）</li>
          <li><strong>Refresh Token</strong>: Access Tokenを更新するための長期間有効なトークン（通常30日）</li>
          <li><strong>ID Token</strong>: ユーザー情報を含むトークン（Access Tokenと同じ有効期限）</li>
        </ul>
        <p>Access Tokenが期限切れになった場合、Refresh Tokenを使用して新しいAccess TokenとID Tokenを取得できる。</p>
        <ul>
          <li>新しいtokenを取得するには、プロバイダーが用意する専用のエンドポイント(/oauth2/token)を仕様する</li>
          <li>SDKを利用した場合、getSessionを呼び出すことで新しいtokenを取得することが可能。ユーザ情報はSDKにログイン時に localStorageに保存されるため、そこから取得する様子</li>
        </ul>
      </div>

      <!-- ローディング表示 -->
      <div id="loading" class="text-center">
        <p>トークン情報を読み込み中...</p>
      </div>

      <!-- ログインしていない場合の表示 -->
      <div id="not-logged-in" class="text-center" style="display: none;">
        <p>ログインしていません。</p>
        <div class="links">
          <a href="../sign_in/" class="resend-link">サインインはこちら</a>
        </div>
      </div>

      <!-- トークン情報表示エリア -->
      <div id="token-info" style="display: none;">
        <div class="mb-4">
          <label>Access Token</label>
          <div id="access-token" class="token-value">-</div>
          <div class="token-meta">
            <span>有効期限: <span id="access-token-exp">-</span></span>
            <span class="token-status" id="access-token-status">-</span>
          </div>
        </div>

        <div class="mb-4">
          <label>ID Token</label>
          <div id="id-token" class="token-value">-</div>
          <div class="token-meta">
            <span>有効期限: <span id="id-token-exp">-</span></span>
            <span class="token-status" id="id-token-status">-</span>
          </div>
        </div>

        <div class="mb-4">
          <label>Refresh Token</label>
          <div id="refresh-token" class="token-value">-</div>
          <div class="token-meta">
            <span>有効期限: <span id="refresh-token-exp">-</span></span>
            <span class="token-status" id="refresh-token-status">-</span>
          </div>
        </div>

        <div class="text-center">
          <button id="refresh-token-btn" type="button">RefreshTokenでトークンを更新</button>
        </div>

        <!-- 更新結果表示エリア -->
        <div id="refresh-result" style="display: none; margin-top: 20px;">
          <h4>更新結果</h4>
          <div id="refresh-message" class="refresh-message"></div>
        </div>
      </div>
    </div>

    <style>
      .token-explanation {
        background-color: #f8f9fa;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .token-explanation h3 {
        color: #2d3748;
        margin-bottom: 15px;
        font-size: 18px;
      }

      .token-explanation p {
        color: #4a5568;
        line-height: 1.6;
        margin-bottom: 10px;
      }

      .token-explanation ul {
        color: #4a5568;
        line-height: 1.6;
        margin-left: 20px;
        margin-bottom: 10px;
      }

      .token-value {
        padding: 12px 16px;
        background-color: #f8f9fa;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        color: #2d3748;
        font-size: 12px;
        font-family: 'Courier New', monospace;
        word-break: break-all;
        max-height: 100px;
        overflow-y: auto;
      }

      .token-meta {
        margin-top: 8px;
        font-size: 16px;
        color: #718096;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .token-status {
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
      }

      .token-status.valid {
        background-color: #c6f6d5;
        color: #22543d;
      }

      .token-status.expired {
        background-color: #fed7d7;
        color: #742a2a;
      }

      #refresh-token-btn {
        background: #3182ce;
        color: white;
        border: none;
        padding: 14px 32px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }

      #refresh-token-btn:hover {
        background: #2c5282;
      }

      #refresh-token-btn:disabled {
        background: #a0aec0;
        cursor: not-allowed;
      }

      .refresh-message {
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
      }

      .refresh-message.success {
        background-color: #c6f6d5;
        color: #22543d;
        border: 1px solid #9ae6b4;
      }

      .refresh-message.error {
        background-color: #fed7d7;
        color: #742a2a;
        border: 1px solid #fc8181;
      }
    </style>

  </body>
</html>
